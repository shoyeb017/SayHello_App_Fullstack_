import 'dart:convert';
import 'package:http/http.dart' as http;

/// üîß AZURE TRANSLATOR SERVICE SETUP GUIDE
/// ========================================
///
/// TO USE THIS SERVICE, YOU NEED TO:
///
/// 1. üåê CREATE AZURE ACCOUNT:
///    - Go to https://portal.azure.com
///    - Create a new "Translator" resource
///    - Choose your subscription and resource group
///
/// 2. üîë GET YOUR CREDENTIALS:
///    - In Azure Portal, go to your Translator resource
///    - Click "Keys and Endpoint" in the left menu
///    - Copy "Key 1" (subscription key)
///    - Note your "Region" (e.g., eastus, westus2)
///
/// 3. ÔøΩ REPLACE THE VALUES BELOW:
///    - Replace 'YOUR_AZURE_SUBSCRIPTION_KEY' with your actual key
///    - Replace 'YOUR_AZURE_REGION' with your actual region
///    - Optionally modify the endpoint if needed
///
/// 4. üéØ CUSTOMIZE (OPTIONAL):
///    - Add more languages in _languageCodes map below
///    - Add more fallback phrases in _getFallbackTranslation method
///
/// üí° The service will use fallback translations when Azure is not configured
/// ========================================

class AzureTranslatorService {
  // ÔøΩ TODO: REPLACE WITH YOUR ACTUAL AZURE CREDENTIALS
  static const String _subscriptionKey =
      '6KLEhYPw2bD1idWMKwvtj5pSDq9DtjUqscfbrKpG1k6zqLXxaiCQJQQJ99BHACYeBjFXJ3w3AAAbACOGTgk5'; // ÔøΩ Put your Azure subscription key here
  static const String _region =
      'eastus'; // üåç Put your Azure region here (e.g., 'eastus', 'westus2')
  static const String _endpoint =
      'https://api.cognitive.microsofttranslator.com'; // üîß Usually no need to change this

  // üåç TODO: Add more language mappings here if you want to support additional languages
  // Current supported languages: English, Spanish, Japanese, Korean, Bengali
  // Azure Translator supports 100+ languages - add them here with their ISO codes
  static const Map<String, String> _languageCodes = {
    'English': 'en',
    'Spanish': 'es',
    'Japanese': 'ja',
    'Korean': 'ko',
    'Bengali': 'bn',
    // üìù ADD MORE LANGUAGES HERE:
    // 'French': 'fr',
    // 'German': 'de',
    // 'Chinese Simplified': 'zh-Hans',
    // 'Arabic': 'ar',
    // 'Hindi': 'hi',
    // etc...
  };

  /// Translates text from source language to target language using Azure Translator
  static Future<String> translateText({
    required String text,
    required String sourceLanguage,
    required String targetLanguage,
  }) async {
    try {
      // üîë AZURE CREDENTIALS CHECK:
      // Make sure you have replaced the placeholder values above with your actual credentials!
      if (_subscriptionKey == 'YOUR_AZURE_SUBSCRIPTION_KEY' ||
          _region == 'YOUR_AZURE_REGION') {
        // Use fallback translation
        return _getFallbackTranslation(text, targetLanguage) ??
            'Azure credentials not configured. Please replace the placeholder values in the code.';
      }

      // Get language codes
      final sourceCode = _languageCodes[sourceLanguage];
      final targetCode = _languageCodes[targetLanguage];

      if (sourceCode == null || targetCode == null) {
        throw Exception(
          'Unsupported language: $sourceLanguage or $targetLanguage',
        );
      }

      // Prepare the request
      final url = Uri.parse(
        '$_endpoint/translate?api-version=3.0&from=$sourceCode&to=$targetCode',
      );

      // üåê AZURE API CALL: This makes the actual translation request to Azure
      // The headers contain your subscription key and region
      final headers = {
        'Ocp-Apim-Subscription-Key':
            _subscriptionKey, // üîë Your Azure key from constants above
        'Ocp-Apim-Subscription-Region':
            _region, // üåç Your Azure region from constants above
        'Content-Type': 'application/json',
      };

      final body = jsonEncode([
        {'text': text},
      ]);

      // Make the API call
      final response = await http.post(url, headers: headers, body: body);

      if (response.statusCode == 200) {
        final List<dynamic> responseData = jsonDecode(response.body);

        if (responseData.isNotEmpty &&
            responseData[0]['translations'] != null &&
            responseData[0]['translations'].isNotEmpty) {
          return responseData[0]['translations'][0]['text'];
        } else {
          throw Exception('Invalid response format from Azure Translator');
        }
      } else {
        throw Exception(
          'Translation failed: ${response.statusCode} - ${response.body}',
        );
      }
    } catch (e) {
      // Return fallback translation or error message
      return _getFallbackTranslation(text, targetLanguage) ??
          'Translation failed: ${e.toString()}';
    }
  }

  /// Detects the language of the input text
  static Future<String> detectLanguage(String text) async {
    try {
      // üîë AZURE CREDENTIALS CHECK FOR LANGUAGE DETECTION:
      // Make sure you have replaced the placeholder values above with your actual credentials!
      if (_subscriptionKey == 'YOUR_AZURE_SUBSCRIPTION_KEY' ||
          _region == 'YOUR_AZURE_REGION') {
        return 'Unknown';
      }

      final url = Uri.parse('$_endpoint/detect?api-version=3.0');

      final headers = {
        'Ocp-Apim-Subscription-Key': _subscriptionKey,
        'Ocp-Apim-Subscription-Region': _region,
        'Content-Type': 'application/json',
      };

      final body = jsonEncode([
        {'text': text},
      ]);

      final response = await http.post(url, headers: headers, body: body);

      if (response.statusCode == 200) {
        final List<dynamic> responseData = jsonDecode(response.body);

        if (responseData.isNotEmpty && responseData[0]['language'] != null) {
          final detectedCode = responseData[0]['language'];

          // Convert back to language name
          for (final entry in _languageCodes.entries) {
            if (entry.value == detectedCode) {
              return entry.key;
            }
          }

          return 'Unknown';
        }
      }

      return 'Unknown';
    } catch (e) {
      return 'Unknown';
    }
  }

  /// Transliterates text to show phonetic pronunciation
  // üî§ TRANSLITERATION: Converts text to phonetic script (e.g., Japanese to Romaji)
  // This helps users understand pronunciation of translated text
  static Future<String?> transliterateText({
    required String text,
    required String language,
  }) async {
    try {
      // üîë AZURE CREDENTIALS CHECK FOR TRANSLITERATION:
      if (_subscriptionKey == 'YOUR_AZURE_SUBSCRIPTION_KEY' ||
          _region == 'YOUR_AZURE_REGION') {
        return null; // No transliteration available without Azure
      }

      final languageCode = _languageCodes[language];
      if (languageCode == null) {
        return null;
      }

      // Only certain languages support transliteration
      final transliterationScripts = {
        'ja': 'Latn', // Japanese to Latin (Romaji)
        'ko': 'Latn', // Korean to Latin
        'bn': 'Latn', // Bengali to Latin
        'ar': 'Latn', // Arabic to Latin
        'hi': 'Latn', // Hindi to Latin
        'zh-Hans': 'Latn', // Chinese to Latin (Pinyin)
      };

      final targetScript = transliterationScripts[languageCode];
      if (targetScript == null) {
        return null; // Language doesn't support transliteration
      }

      final url = Uri.parse(
        '$_endpoint/transliterate?api-version=3.0&language=$languageCode&fromScript=&toScript=$targetScript',
      );

      final headers = {
        'Ocp-Apim-Subscription-Key': _subscriptionKey,
        'Ocp-Apim-Subscription-Region': _region,
        'Content-Type': 'application/json',
      };

      final body = jsonEncode([
        {'text': text},
      ]);

      final response = await http.post(url, headers: headers, body: body);

      if (response.statusCode == 200) {
        final List<dynamic> responseData = jsonDecode(response.body);

        if (responseData.isNotEmpty && responseData[0]['text'] != null) {
          return responseData[0]['text'];
        }
      }

      return null;
    } catch (e) {
      return null;
    }
  }

  /// Gets available translation languages
  // üìù TODO: If you add more languages to _languageCodes above, they will automatically
  // appear here. This returns the list of supported languages for the UI.
  static List<String> getSupportedLanguages() {
    return _languageCodes.keys.toList();
  }

  /// Fallback translations for common phrases when Azure service is unavailable
  // üí° FALLBACK SYSTEM: These translations are used when:
  // 1. Azure credentials are not configured
  // 2. Azure API is unavailable
  // 3. Network connection fails
  // üìù TODO: Add more fallback phrases here if needed
  static String? _getFallbackTranslation(String text, String targetLanguage) {
    final fallbackTranslations = {
      // üìù TODO: Add more common phrases here for better offline experience
      // Each phrase needs translations in all your supported languages
      "hello": {
        "English": "Hello",
        "Spanish": "Hola",
        "Japanese": "„Åì„Çì„Å´„Å°„ÅØ",
        "Korean": "ÏïàÎÖïÌïòÏÑ∏Ïöî",
        "Bengali": "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã",
      },
      "goodbye": {
        "English": "Goodbye",
        "Spanish": "Adi√≥s",
        "Japanese": "„Åï„Çà„ÅÜ„Å™„Çâ",
        "Korean": "ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî",
        "Bengali": "‡¶¨‡¶ø‡¶¶‡¶æ‡¶Ø‡¶º",
      },
      "thank you": {
        "English": "Thank you",
        "Spanish": "Gracias",
        "Japanese": "„ÅÇ„Çä„Åå„Å®„ÅÜ",
        "Korean": "Í∞êÏÇ¨Ìï©ÎãàÎã§",
        "Bengali": "‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶",
      },
      "yes": {
        "English": "Yes",
        "Spanish": "S√≠",
        "Japanese": "„ÅØ„ÅÑ",
        "Korean": "ÎÑ§",
        "Bengali": "‡¶π‡ßç‡¶Ø‡¶æ‡¶Å",
      },
      "no": {
        "English": "No",
        "Spanish": "No",
        "Japanese": "„ÅÑ„ÅÑ„Åà",
        "Korean": "ÏïÑÎãàÏöî",
        "Bengali": "‡¶®‡¶æ",
      },
      "please": {
        "English": "Please",
        "Spanish": "Por favor",
        "Japanese": "„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô",
        "Korean": "Î∂ÄÌÉÅÌï©ÎãàÎã§",
        "Bengali": "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá",
      },
      "excuse me": {
        "English": "Excuse me",
        "Spanish": "Disculpe",
        "Japanese": "„Åô„Åø„Åæ„Åõ„Çì",
        "Korean": "Ïã§Î°ÄÌï©ÎãàÎã§",
        "Bengali": "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§",
      },
      "good morning": {
        "English": "Good morning",
        "Spanish": "Buenos d√≠as",
        "Japanese": "„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô",
        "Korean": "Ï¢ãÏùÄ ÏïÑÏπ®",
        "Bengali": "‡¶∏‡ßÅ‡¶™‡ßç‡¶∞‡¶≠‡¶æ‡¶§",
      },
      "good night": {
        "English": "Good night",
        "Spanish": "Buenas noches",
        "Japanese": "„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ",
        "Korean": "ÏïàÎÖïÌûà Ï£ºÎ¨¥ÏÑ∏Ïöî",
        "Bengali": "‡¶∂‡ßÅ‡¶≠ ‡¶∞‡¶æ‡¶§‡ßç‡¶∞‡¶ø",
      },
      "how are you": {
        "English": "How are you?",
        "Spanish": "¬øC√≥mo est√°s?",
        "Japanese": "ÂÖÉÊ∞ó„Åß„Åô„ÅãÔºü",
        "Korean": "Ïñ¥ÎñªÍ≤å ÏßÄÎÇ¥ÏÑ∏Ïöî?",
        "Bengali": "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßá‡¶®?",
      },
      // üí° ADD MORE FALLBACK PHRASES HERE:
      // "I love you": {
      //   "English": "I love you",
      //   "Spanish": "Te amo",
      //   "Japanese": "ÊÑõ„Åó„Å¶„Çã",
      //   "Korean": "ÏÇ¨ÎûëÌï¥",
      //   "Bengali": "‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø",
      // },
    };

    final normalizedText = text.toLowerCase().trim();
    return fallbackTranslations[normalizedText]?[targetLanguage];
  }

  /// Checks if the Azure Translator service is properly configured
  // ‚úÖ CONFIGURATION CHECK: This method verifies if Azure credentials are set up
  // Returns true when the placeholder values have been replaced with actual credentials
  static Future<bool> isConfigured() async {
    return _subscriptionKey != 'YOUR_AZURE_SUBSCRIPTION_KEY' &&
        _region != 'YOUR_AZURE_REGION' &&
        _subscriptionKey.isNotEmpty &&
        _region.isNotEmpty;
  }
}
